// @ts-nocheck
require(["esri/WebMap","esri/views/MapView","esri/layers/FeatureLayer","esri/core/reactiveUtils","esri/Graphic","esri/layers/GraphicsLayer","esri/widgets/BasemapLayerList","esri/widgets/Legend"],(function(e,t,r,s,n,o,i,a){const l=new URLSearchParams(window.location.search);let c=window.location.href,u=l.get("viewer");let d=["colebrookct","columbiact","durhamct","franklinct","haddamct","northcanaanct","roxburyct","roxburyctassessor","scotlandct","warrenct","warrenctassessor","washingtonct","wiltonct","wolcottct"].join("|"),m=new RegExp(`\\?viewer=cama\\/(${d})(\\&\\w+=[\\w-]+)*$`);null!=u&&m.test(c)?u+=".json":"https://terrenogis.com"===window.location.href||"https://terrenogis.com/"===window.location.href?window.location.href="https://www.qds.biz/gis-service":window.location.href="./onload.html";const p={mapId:"",condoLayer:"",title:"",isCondosLayer:"",noCondoLayer:""};fetch(u).then((e=>e.json())).then((s=>{p.mapId=s.webmapId||"6448b08504de4244973a28305b18271f",p.condoLayer=s.condoLayer,p.noCondoLayer=s.noCondoLayer,p.title=s.title,p.isCondosLayer=s.condos,p.masterTable=s.masterTable,p.zoom=s.zoom,p.parcelZoom=s.parcelZoom,p.imageUrl=s.imageUrl,p.welcomeImage=s.welcomeImage,p.pdf_Image=s.pdf_Image,p.pdf_demo=s.pdf_demographics,p.taxMap_Url=s.taxMapUrl,p.parcelMapUrl=s.parcelMapUrl,p.housingUrl=s.housingUrl,p.propertyCardPdf=s.propertyCardPdf,p.propertyCard=s.propertyCard,p.tax_bill=s.tax_bill,p.useVisionForTaxBillUrl=s.useVisionForTaxBillUrl,p.accessorName=s.accessorName,p.parcelTitle=s.parcelServiceTitle,p.tabTitle=s.tabTitle,p.basemapTitle=s.basemapTitle,p.parcelRenderer=s.parcelRenderer,p.useUniqueIdforParcelMap=s.useUniqueIdforParcelMap,p.helpUrl=s.helpUrl,p.includeFilter=s.includeFilter,p.customWelcomePage=s.customWelcomePage,p.customWelcomeMessage=s.customWelcomeMessage,p.showDisclaimer=s.showDisclaimer,p.customDisclaimerPage=s.customDisclaimerPage,p.customDisclaimerMessage=s.customDisclaimerMessage,p.DetailLinks=s.DetailLinks,p.DetailLinksToInclude=s.DetailLinksToInclude,p.includePermitLink=s.includePermitLink,p.scale=s.scale,$(".help-url").attr("href",p.helpUrl);const i=document.getElementById("clear-btn"),a=new o;let l,c,u,d=[];const m=new e({portalItem:{id:p.mapId},layers:[a]});var g=new t({container:"viewDiv",map:m,units:"imperial",scale:p.scale,popupEnabled:!1,ui:{components:["attribution"]}});g.when((()=>{p.homeExtent=g.extent}));const h=new r({url:`${p.noCondoLayer}`,visible:!1,popupEnabled:!0,title:"Parcel Boundaries",id:"noCondoLayer"}),f=new r({url:`${p.condoLayer}`,visible:!1,popupEnabled:!0,title:"Parcel Boundaries",id:"condoLayer"}),b=new r({url:`${p.masterTable}`}),y=new r({url:`${p.masterTable}`});function I(e){let t=e.attributes.OBJECTID,r=e.attributes.Location,s=e.attributes.Uniqueid,n=e.attributes.GIS_LINK,o=e.attributes.Co_Owner,i=e.attributes.Owner,a=e.attributes.MBL,l=e.geometry,c=e.attributes.Mailing_Address_1,u=e.attributes.Mailing_Address_2,m=e.attributes.Mailing_City,p=e.attributes.Mail_State,g=e.attributes.Mailing_Zip,h=e.attributes.Total_Acres,f=e.attributes.Parcel_Primary_Use,b=e.attributes.Building_Use_Code,y=e.attributes.Parcel_Type,I=e.attributes.Design_Type,L=e.attributes.Zoning,w=e.attributes.Neighborhood,$=e.attributes.Land_Type_Rate,_=e.attributes.Functional_Obs,T=e.attributes.External_Obs,E=e.attributes.Sale_Date,v=(x=new Date(E),C=x.getDate(),x.getMonth()+1+"/"+C+"/"+x.getFullYear());var x,C;let S=e.attributes.Sale_Price,k=e.attributes.Vol_Page,M=e.attributes.Assessed_Total,O=e.attributes.Appraised_Total,P=e.attributes.Influence_Factor,B=e.attributes.Influence_Type,R=e.attributes.Land_Type,D=e.attributes.Prior_Assessment_Year,G=e.attributes.Prior_Assessed_Total,K=e.attributes.Prior_Appraised_Total,N=e.attributes.Map,U=e.attributes.Lat,q=e.attributes.Lon,F=e.attributes.Image_Path,A=e.attributes.AcctNum,j=e.attributes.Match_Status,z=e.attributes.ACCOUNT_TYPE;d.push(new Parcel(t,r,s,n,o,i,a,l,c,u,m,p,g,h,f,b,y,I,L,w,$,_,T,v,S,k,M,O,P,B,R,D,G,K,N,U,q,F,A,j,z))}function L(e){const t=document.getElementById("results"),r=document.createElement("ul");let s,n;e.forEach((function(e){let t=e.objectid,o=e.location,i=void 0===e.uniqueId?e.GIS_LINK:e.uniqueId,a=e.GIS_LINK,l=e.coOwner,c=e.owner,u=e.MBL,d=e.geometry,m=e.Parcel_Type;"yes"===p.useUniqueIdforParcelMap?(s=i,n=i):(s=a,n=a);let g=e.Image_Path,h=void 0===e.AcctNum?"":e.AcctNum;const f=`${p.imageUrl}${g}`;r.classList.add("row"),r.classList.add("list-group");const b=document.createElement("li"),y=document.createElement("li"),I=document.createElement("tr");I.classList.add("col-12","list-group-item");let L,w,$=`<div class="extra-links">\n            <a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=https://publicweb-gis.s3.amazonaws.com/PDFs/${p.parcelMapUrl}/Quick_Maps/QM_${n}.pdf><span style="font-family:Tahoma;font-size:12px;"><strong>PDF Map</strong></a>`;"yes"==p.propertyCardPdf?$+=`<a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=${p.propertyCard}${i}.PDF><span style="font-family:Tahoma;font-size:12px;"><strong>Property Card</strong></a>`:$+=`<a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=${p.propertyCard}${i}><span style="font-family:Tahoma;font-size:12px;"><strong>Property Card</strong></a>`,"yes"===p.useVisionForTaxBillUrl?$+=`<a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=${p.tax_bill}&amp;uniqueId=${h}><span style="font-family:Tahoma;font-size:12px;"><strong>Tax Bills</strong></span></a>`:$+=`<a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=${p.tax_bill}&amp;uniqueId=${i}><span style="font-family:Tahoma;font-size:12px;"><strong>Tax Bills</strong></span></a>`,"yes"===p.includePermitLink&&($+=`<a target="_blank" class='pdf-links mx-2' rel="noopener noreferrer" href=${p.permitLink}?uniqueid=${i} ><span style="font-family:Tahoma;font-size:12px;"><strong>Permits</strong></a>`),$+="</div>",I.innerHTML=$,y.innerHTML=`<img class="img-search image" object-id="${t}" src="${f}" alt="Image of ${i}" >`,b.classList.add("list-group-item","col-9"),b.classList.add("search-list"),y.setAttribute("object-id",t),y.setAttribute("data-id",a),y.classList.add("image-div","col-3"),w="yes"===sessionStorage.getItem("No geometry"),!l&&d||d?L=` <div class="listText">UID: ${i}  &nbsp;<br>MBL: ${u} <br> ${c} ${l} <br> ${o} <br> Property Type: ${m}</div>\n            <div class="justZoomBtn"><button type="button" class="btn btn-primary btn-sm justZoom" title="Zoom to Parcel"><calcite-icon icon="magnifying-glass-plus" scale="s"/>Zoom</button><button type="button" class="btn btn-primary btn-sm justRemove" title="Remove from Search List"><calcite-icon icon="minus-circle" scale="s"/>Remove</button></div>`:(L=` <div class="listText noGeometry">UID: ${i}  &nbsp;<br>MBL: ${u} <br> ${c} ${l} <br> ${o} <br> Property Type: ${m} \n             </div><div class="justZoomBtn"><button type="button" class="btn btn-primary btn-sm justRemove" title="Remove from Search List"><calcite-icon icon="minus-circle" scale="s"/>Remove</button></div>`,b.classList.add("no-zoomto")),b.innerHTML+=L,b.setAttribute("object-id",t),b.setAttribute("data-id",a),r.appendChild(y),r.appendChild(b),r.appendChild(I)})),function(e){e.addEventListener("click",(function(e){let t=!0;if(e.target.closest(".justZoom")||e.target.closest(".justZoomBtn")||e.target.closest(".pdf-links"))return;$("#select-button").attr("title","Select Enabled");let r=e.target.closest("li");if(!r)return;let s=r.getAttribute("data-id"),n=r.getAttribute("object-id");zoomToFeature(n,s),$("#details-spinner").show(),$("#WelcomeBox").hide(),$("#featureWid").hide(),$("#result-btns").hide(),$("#total-results").hide(),$("#ResultDiv").hide(),$("#abutters-content").hide(),$("#details-btns").show(),$("#abut-mail").show(),$("#detailBox").show(),$("#backButton").show(),$("#detailsButton").hide(),$("#detail-content").empty(),$("#selected-feature").empty(),$("#exportButtons").hide(),$("#exportSearch").hide(),$("#exportResults").hide(),$("#csvExportResults").hide(),$("#csvExportSearch").hide(),$("#results-div").css("height","300px"),$("#backButton-div").css("padding-top","0px"),$(".center-container").hide(),$("#abutters-attributes").prop("disabled",!1),$("#abutters-zoom").prop("disabled",!1),e.target.closest(".no-zoomto")&&(console.log("dont zoom"),t=!1)}))}(r),t.appendChild(r)}function w(e,t,r,s,n,o){$("status-loader").show(),$("#results").empty();let{uniqueArray:i,seenIds:a}=function(e){let t=new Set,r=new Set,s=e.filter((e=>!!e.geometry&&(t.add(e.uniqueId),!0)));return e.forEach((e=>{t.has(e.uniqueId)||(r.add(e.uniqueId),s.push(e))})),{uniqueArray:s,seenIds:t}}(d);var l;i=i.sort(((e,t)=>{const r=e.owner?e.owner.toLowerCase():"",s=t.owner?t.owner.toLowerCase():"";return r.localeCompare(s)})),l=s,d.filter((e=>e.objectid===l)).length>1&&(i=function(e,t,r,s){return"yes"===sessionStorage.getItem("condos")?($(`li[object-id="${t}"]`).remove(),e.filter((e=>e.objectid!==t))):($(`li[data-id="${s}"]`).remove(),e.filter((e=>e.GIS_LINK!==s)))}(i,s,0,o)),L(i),searchResults=i.length,$("#total-results").html(searchResults+" results returned")}let _;function T(e,t,r,s){let o,i;if(e.features.length>0&&(o=e.features[0].attributes.Owner),"RESIDENT"!=o||r){_=s?e:e.features;let o,l,u=[];var a={type:"simple-fill",color:[127,42,145,.4],outline:{color:[127,42,145,.8],width:2}};if(r){o=e.features[0].attributes.OBJECTID,l=_[0].attributes.GIS_LINK;const r=new n({geometry:_[0].geometry,symbol:a,id:o});if(u.push(r),countCondos=d.filter((e=>e.GIS_LINK===l)).length,i=g.graphics.some((e=>e.id===o)),i){const e=g.graphics.findIndex((e=>e.id===o));g.graphics.removeAt(e);const t=c.findIndex((e=>e.id===o));1===c.length?c.splice(0,1):c.splice(t,1),0===c.length&&(DetailsHandle||(DetailsHandle=g.on("click",handleDetailsClick)),clickHandle&&(clickHandle?.remove(),clickHandle=null),clickHandle=g.on("click",handleClick))}else t.addMany(u)}else if(s){_.filter((e=>e.geometry)).forEach((e=>{const t=e.attributes.OBJECTID,r=new n({geometry:e.geometry,symbol:a,id:t});u.push(r)})),u.length>=1&&t.addMany(u),g.goTo({target:c,zoom:18})}else{let e;if(regSearch=!0,_.map((function(t){if(o=t.attributes.OBJECTID,!t.geometry||s)return null;e=new n({geometry:t.geometry,symbol:a,id:o}),u.push(e)})).filter((e=>null!==e)),1==u.length){t.addMany(u);const e=_[0].geometry.extent,r=(e.center,2),s=e.expand(r);g.goTo({target:u,extent:s})}else if(t.addMany(u),u.length>0){const e=u.map((e=>e.geometry.extent)),t=3,r=e.reduce(((e,t)=>e.union(t)),e[0]).expand(t);g.goTo({target:r}).catch((e=>{console.error("Error zooming to extent:",e)}))}else console.warn("No graphics available to calculate extent.")}if(c||(c=u),r&&!i){let e=u[0].id;c=[...c,u[0]],removeFromList=e}regSearch&&(c=u),i=!1,regSearch=!1}else console.log("serach on resident not clicking")}function E(e,t,r,s){let n,o,i,a=!1;function l(e){e.forEach((function(e){(""!==e.attributes.Owner&&"RESIDENT"!==e.attributes.Owner||lasso||a)&&I(e)}))}if(r&&null!=r){a=!0,n=e[0].attributes.OBJECTID,o=e[0].attributes.Location,i=e[0].attributes.GIS_LINK;const t=d.filter((e=>e.objectid===n)).length,r=d.filter((e=>e.GIS_LINK===i)).length;t>=1||0==t&&r>=1?(l(e),w(0,0,0,n,0,i)):(l(e),w())}else e?(e.length,l(e)):w(0,0,0,n);r||w(0,0,0,n,0,i)}function v(e,t,r){let s,n,o;"no"===sessionStorage.getItem("condos")?h.visible=!0:f.visible=!0,$(".spinner-container").show(),s=`\n          Street_Name LIKE '%${e}%' OR \n          MBL LIKE '%${e}%' OR \n          Location LIKE '%${e}%' OR \n          Co_Owner LIKE '%${e}%' OR \n          Uniqueid LIKE '%${e}%' OR \n          Owner LIKE '%${e}%' OR \n          GIS_LINK LIKE '%${e}%'\n      `,r?n=r:l&&(n=r,tableSearch=!0),"no"===sessionStorage.getItem("condos")?h.queryFeatures(n).then((function(i){if(o=i.features,i.features.length>=0)if(o=i.features,noCondosParcelGeom=i.features,triggerfromNoCondos){let r="",s="";const i=y.createQuery();i.where=n.where,i.returnGeometry=!1,i.outFields=["*"],y.queryFeatures(i).then((function(e){r=e.features;const t=e.features[0].attributes.GIS_LINK;let s=h.createQuery();return s.where=`GIS_LINK = '${t}'`,s.returnGeometry=!0,s.returnHiddenFields=!0,s.outFields=["*"],h.queryFeatures(s)})).then((function(n){o=n.features,s=n.features,noCondosParcelGeom=n.features,T(n,g.graphics,""),E(n.features),t&&setTimeout((()=>{triggerListGroup(r,s,e)}),200)})).catch((function(e){console.error("Error querying features: ",e)}))}else noCondosParcelGeom=i.features,T(i,g.graphics,""),E(i.features),t&&setTimeout((()=>{triggerListGroup(o,e)}),200),triggerfromNoCondos=!1;else if(1===i.features.length&&d.length>2){const r=y.createQuery();r.where=s,r.returnGeometry=!1,r.outFields=["*"],y.queryFeatures(r).then((function(r){T(r.features),E(),t&&setTimeout((()=>{triggerListGroup(o,e)}),200)}))}else{const e=y.createQuery();e.where=r.where,e.returnGeometry=!1,e.outFields=["*"],0==i.features.length&&y.queryFeatures(e).then((function(e){o=e.features,GISLINK=e.features[0].attributes.GIS_LINK;let r=e.features[0].attributes.Uniqueid;noCondosParcelGeom=e.features,T(e,g.graphics),E(e.features),t&&setTimeout((()=>{needToSearchGisLink=!0,triggerListGroup(o,r)}),200)}))}})):f.queryFeatures(n).then((function(e){if(o=e.features,e.features.length>0){const r=e.features[0].attributes.Uniqueid;T(e,g.graphics,""),t&&setTimeout((()=>{triggerListGroup(o,r)}),200)}E(e.features)}))}const x=()=>{let e;d=[],$("#suggestions").val("").html("");let t=u;if(console.log(t),t?.length<3||!t)C();else{let r;l?r=filterQuery:(r=b.createQuery(),r.where=`\n              Street_Name LIKE '%${t}%' OR \n              MBL LIKE '%${t}%' OR \n              Location LIKE '%${t}%' OR \n              Co_Owner LIKE '%${t}%' OR \n              Uniqueid LIKE '%${t}%' OR \n              Owner LIKE '%${t}%' OR\n              GIS_LINK LIKE '%${t}%'\n            `,r.returnGeometry=!1,r.returnHiddenFields=!0,r.outFields=["*"]),b.queryFeatures(r).then((s=>{if(s.features.length>0){e=s.features,"MISMATCH"===s.features[0].attributes.Match_Status&&"Condominium"===s.features[0].attributes.Parcel_Type&&(triggerfromNoCondos=!0),e.forEach((function(e){const r=function(e,t){const r=t.attributes?.Location;return r.includes(e)}(t,e);""===e.attributes.Owner||"RESIDENT"===e.attributes.Owner&&!r||I(e)}));let n=null;l&&(o.where=filterQuery.where,n=!0);const o=function(e){let t;return"no"===sessionStorage.getItem("condos")?(t=h.createQuery(),t.where=e.where,t.returnDistinctValues=!1,t.returnGeometry=!0,t.outFields=["*"]):(t=f.createQuery(),t.where=e.where,t.returnDistinctValues=!1,t.returnGeometry=!0,t.outFields=["*"]),t}(r);v(u,n,o)}})).catch((e=>{console.error("Error querying for details:",e)}))}};function C(e,t){const r=function(e,t){let r,s=t.split("?")[0],n=[],o=-1!==t.indexOf("?")?t.split("?")[1]:"";if(""!==o){n=o.split("&");for(let t=n.length-1;t>=0;t-=1)r=n[t].split("=")[0],r===e&&n.splice(t,1);s=s+"?"+n.join("&")}return s}("uniqueid",window.location.href);window.history.pushState({path:r},"",r),"no"===sessionStorage.getItem("condos")?h.visible=!0:f.visible=!0,u="",$("#searchInput ul").remove(),$("#searchInput").val="";document.getElementById("searchInput").value="",searchTerm="",d=[],secondList=[],zoomToObjectID="",l=!1,triggerfromNoCondos=!1,$(".spinner-container").hide(),$("#dropdown").hide(),$("#suggestions").hide(),urlBackButton=!1,document.getElementById("suggestions").innerHTML="",g.graphics.removeAll(),c=[]}document.getElementById("searchInput").addEventListener("input",(function(e){d=[],secondList=[],c=[],g.graphics.removeAll(),$("#suggestions").html(""),u=e.target.value.toUpperCase().replace(/&amp;/g,"&"),u.length>1?function(e){const t=["Street_Name","MBL","Location","Co_Owner","Uniqueid","Owner","GIS_LINK"];$("#searchInput ul").remove(),$("#suggestions").hide(),$("#dropdown").show();let r=`\n            Street_Name LIKE '%${e}%' OR \n            MBL LIKE '%${e}%' OR \n            Location LIKE '%${e}%' OR \n            Co_Owner LIKE '%${e}%' OR \n            Uniqueid LIKE '%${e}%' OR \n            Owner LIKE '%${e}%' OR\n            GIS_LINK LIKE '%${e}%'\n        `,s=y.createQuery();s.where=r,s.returnGeometry=!1,s.outFields=t;let n=new Set;y.queryFeatures(s).then((r=>{let s=document.getElementById("suggestions");s.innerHTML="",r.features.forEach((r=>{t.forEach((t=>{let o=r.attributes[t];if(o&&o.includes(e)&&!n.has(o)){let e=document.createElement("div");e.className="list-group-item",e.innerText=`${o}`,s.appendChild(e),n.add(o),s.style.display="block",e.addEventListener("click",(function(e){clickedToggle=!0,x(e.target.innerHTML),clickedToggle=!1}))}}))}))}))}(u):$("#suggestions").hide()})),document.addEventListener("click",(function(e){"searchInput"!==e.target.id&&(document.getElementById("suggestions").style.display="none")})),i.addEventListener("click",(function(){C()})),document.getElementById("searchButton").addEventListener("click",(function(e){e.preventDefault(),$("#results-div").css("left","0px"),clearTimeout(debounceTimer2),debounceTimer2=setTimeout((()=>{"no"===sessionStorage.getItem("condos")?h.visible=!0:f.visible=!0,$("dropdown").empty(),$("#total-results").show(),$("#ResultDiv").hide(),c=[],g.graphics.removeAll(),x()}),300)}))}))}));